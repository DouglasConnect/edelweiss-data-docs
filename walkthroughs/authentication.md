
# API Authentication

There are two types of Tokens for authenticating with EdelweissData API. They are

1. [Access Token](#access-tokens)
2. [Refresh Token](#refresh-tokens)

**⚠️  Tokens take the place of passwords in authentication flows, and they should be treated with care. Keep your tokens private, and do not hard-code them into your scripts.**

## Access Tokens
This is the primary way of authenticating to the EdelweissData API.
Access tokens tell the API who are you, and that you have the permissions to access your datasets.
Access tokens expires after a 24 hours, after which you will need to generate a new one.

Access tokens are supplied to the API in the HTTP headers of your request.  For example, sending a bearer token with fetch request to list datasets:

```js
let edelweissUrl = "https://api.edelweissdata.com"
fetch(`${edelweissUrl}/datasets`, {
    headers: {
        'Authorization': `bearer ${accessToken}`
    },
})
```

### Generating Access Tokens
There are typically two ways to generate an access token, They are:

- From Edelweiss UI
- From Edelweiss Data CLI

### Generate an access token from the Edelweiss UI

To get your access token you simply take the following steps:

- Navigate to [My Datasets](https://edelweissdata.com/datasets/manage) Page.  You will be asked to sign in if you have not done so already.
- Click the "Get API Key" button
- Click the "Copy Key" button


### Generate an access token using the Edelweiss Data CLI.

The cli tool is published as a [package in npmjs](https://www.npmjs.com/package/edelweiss-data-cli). You can install the cli globally:

```bash
# Install with yarn
yarn add -g edelweiss-data-cli
# Or install with npm
npm install -g edelweiss-data-cli
```

Now you can generate an access token at any time by running this command:

```bash
edelweiss authenticate
```

The CLI responds with:

```
Visit this url in your web browser to sign into edelweiss:
https://edelweiss.eu.auth0.com/activate?user_code=XXXX-XXXX

Your authorization token is XXXX-XXXX
Waiting for authentication.....
```

Open the url in your web browser and follow the instructions to sign up or sign in. After you have signed in via the web browser, the CLI will print out the result:

- `access_token` - this is the bearer token for you to attach to all http requests.
- `expires_in` - the number of seconds until your access token expires; by default 86400 seconds.


Use the `--help` flag to see what options are available with the authenticate command:

```bash
yarn run authenticate -- --help
```

**Caution**: If you sign up with a new email/password then you will receive an email to let you validate your address.  Access tokens generated by the CLI tool are not valid until you have validated your email address.

## Refresh Tokens

Refresh tokens are a solution to the problem that access tokens expire after 24 hours.

Imagine you have an app that periodically interacts with edelweiss over an extended period of time.
For example, it might be a daily cron job that automatically creates new datasets on behalf of a user.
Supplying a regular access token to this app would be inappropriate because it would expire too quickly.

That's where refresh tokens come in. Refresh tokens never expire, and they can be exchanged for an access token at any time.
Just like access tokens, refresh tokens identify a specific user, so they can only be used to access datasets for that user.

Also just like access tokens, you should be careful where you store these as whoever has access to them can impersonate the user.

### Generating a Refresh Token
You can generate a refresh token using the [Edelweiss Data CLI](https://www.npmjs.com/package/edelweiss-data-cli).

```bash
edelweiss authenticate --refresh-token
```

This will display something similar to the following
```json
{
    "access_token": "eyJhbGciOiJSUzI1NiIsInR......RMQMsHnT_z-Ta21_d_Aq9lXT9w",
    "refresh_token": "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
    "scope": "offline_access",
    "expires_in" : 86400,
    "token_type": "Bearer"
}
```

### Generating an Access Token using a Refresh Token
In order to generate an access token using code, first you will need the native client id. you can retrieve this from the `/oidc` endpoint e.g. simply call
```javascript
fetch(`${edelweissUrl}/oidc`, { method: 'GET' })
    .then(response  =>  response.json())
    .then(data  =>  console.log('Success:', data))
    .catch((error) => {
        console.error('Error:', error);
    });
```
and you will get an output like this

```json
{
    "domain":  "edelweiss.eu.auth0.com",
    "audience":  "https://api.edelweissdata.com",
    "nativeClientId":  "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
    "webClientId":  "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
}
```

Here we need two pieces of information, the domain and the `nativeClientId` and then we can simply call the `oauth/token` endpoint of the authentication domain in order to retrieve the access token as follows:

```javascript
let formData = new FormData();

formData.append('grant_type', 'refresh_token');
formData.append('client_id', nativeClientId);
formData.append('refresh_token', refreshToken);

let  fetchOptions = {
    method:  'POST',
    headers: {
        'Content-Type':  'application/x-www-form-urlencoded'
    },
    body:  formData
}

fetch(`${domain}/oauth/token`, fetchOptions)
    .then(response  =>  response.json())
    .then(data  =>  console.log('Success:', data))
    .catch((error) => {
        console.error('Error:', error);
    });
```

and you should get an output like this

```json
{
    "access_token": "eyJhbGciOiJSUzI1NiIsInR......RMQMsHnT_z-Ta21_d_Aq9lXT9w",
    "expires_in": 86400,
    "scope": "openid offline_access",
    "id_token": "eyJhbGciOiJSUzI1cv1dGbwc......NFZJKyS43kt4HoWR7wlaUFaDQ",
    "token_type": "Bearer"
}
```
which contains your access token and returns the lifetime of the access token in seconds
