
# API Authentication


There are two types of Tokens for authenticating with EdelweissData API. They are

1. Access Token
2. Refresh Token

## Access Tokens
This is the primary way of authenticating with the EdelweissData API. These Tokens are short lived and will expire after a few minutes. This is great if you simply want to execute a script against your datasets.

Because they are short lived, It's relatively safe to share scripts that contain these tokens.

The Edelweiss Data API uses bearer tokens in HTTP requests in order to authenticate the requester and to allow access to protected datasets.

For example, sending a bearer token with fetch request to list datasets:

```js
fetch(`${baseUrl}/datasets`, {
    headers: {
        'Authorization': `bearer ${token}`
    },
})
```
There are typically two ways to generate an access token, They are:

- From Edelweiss UI
- From Edelweiss Data CLI

### Generate an access token from the Edelweiss UI

To get your access token simply login you simply take the following steps

- Navigate to [My Datasets](https://edelweissdata.com/datasets/manage) Page.
- Click the "Get API Key" button
- Click the "Copy Key" button


### Generate an access token using the Edelweiss Data CLI.

The cli tool is bundled as part of this repo. Here are the steps to check out the code and install dependencies:

```bash
# Clone this repo
git clone https://github.com/DouglasConnect/edelweiss-data-docs.git
cd edelweiss-data-docs

# Install dependencies
yarn install
```

Now you can generate an access token at any time by running this command from the root directory of this repo:

```bash
yarn run authenticate
```

The CLI responds with:

```
Visit this url in your web browser to sign into edelweiss:
https://edelweiss.eu.auth0.com/activate?user_code=XXXX-XXXX

Your authorization token is XXXX-XXXX
Waiting for authentication.....
```

Open the url in your web browser and follow the instructions to sign up or sign in. After you have signed in via the web browser, the CLI will print out the result:

- `access_token` - this is the bearer token for you to attach to all http requests.
- `expires_in` - the number of seconds until your access token expires; by default 86400 seconds.


Use the `--help` flag to see what options are available with the authenticate command:

```bash
yarn run authenticate -- --help
```

*Caution*: If you sign up with a new email/password then you will receive an email to let you validate your address.  Access tokens generated by the CLI tool are not valid until you have validated your email address.

## Refresh Tokens

As convenient as Access Tokens are, this approach will not work for applications that have to run on behalf of the user. In this case we need a way to generate access tokens without exposing the username and password. And applications might want to perpetually act on the user. For example, you might want to write an app that creates new versions of datasets in Edelweiss Data periodically.

That's where refresh tokens come in. They almost an equivalent to a username/password pair for the User so applications can use them to generate access tokens automatically without requiring the user to login

However, unlike Access Tokens, they are very sensitive and long lived so you need to be careful where you store them as whoever has access to them can impersonate the User.

### Generating a Refresh Token
You can only generate the refresh token using the Edelweiss Data CLI.

```bash
git clone https://github.com/DouglasConnect/edelweiss-data-docs.git
cd edelweiss-data-docs
yarn install
yarn run authenticate --refresh-token
```
This will display something similar to the following
```json
{
    "access_token": "eyJhbGciOiJSUzI1NiIsInR......RMQMsHnT_z-Ta21_d_Aq9lXT9w",
    "refresh_token": "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
    "scope": "offline_access",
    "expires_in" : 86400,
    "token_type": "Bearer"
}
```

### Generating an Access Token using a Refresh Token
In order to generate an access token using code, first you will need the native client id. you can retrieve this from the `/oidc` endpoint e.g. simply call
```javascript
fetch(`${baseUrl}/oidc`, { method: 'GET' })
	.then(response  =>  response.json())
	.then(data  =>  console.log('Success:', data))
	.catch((error) => {
		console.error('Error:', error);
	});
```
and you will get an output like this

```json
{
    "domain":  "edelweiss.eu.auth0.com",
    "audience":  "https://api.edelweissdata.com",
	"nativeClientId":  "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
    "webClientId":  "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
}
```

Here we need two pieces of information, the domain and the `nativeClientId` and then we can simply call the `oauth/token` endpoint of the authentication domain in order to retrieve the access token as follows:

```javascript
let formData = new FormData();

formData.append('grant_type', 'refresh_token');
formData.append('client_id', nativeClientId);
formData.append('refresh_token', refreshToken);

let  fetchOptions = {
	method:  'POST',
	headers: {
		'Content-Type':  'application/x-www-form-urlencoded'
	},
	body:  formData
}

fetch(`${domain}/oauth/token`, fetchOptions)
	.then(response  =>  response.json())
	.then(data  =>  console.log('Success:', data))
	.catch((error) => {
		console.error('Error:', error);
	});
```

and you should get an output like this

```json
{
	"access_token": "eyJhbGciOiJSUzI1NiIsInR......RMQMsHnT_z-Ta21_d_Aq9lXT9w",
	"expires_in": 86400,
	"scope": "openid offline_access",
	"id_token": "eyJhbGciOiJSUzI1cv1dGbwc......NFZJKyS43kt4HoWR7wlaUFaDQ",
	"token_type": "Bearer"
}
```
which contains your access token and returns the lifetime of the access token in seconds